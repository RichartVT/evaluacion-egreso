<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Alumno — Inicio</title>
    <link rel="stylesheet" href="/assets/css/base.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="container row between middle">
        <h1 class="title">Portal del Alumno</h1>
        <div class="row middle gap-8">
          <span id="resumen-usuario" class="muted"></span>
          <button id="btn-cerrar-sesion" class="btn btn-danger">
            Cerrar sesión
          </button>
        </div>
      </div>
    </header>

    <main class="container" style="max-width: 960px">
      <div class="card" style="margin: 24px auto">
        <h2 id="saludo">Bienvenido</h2>
        <p class="muted">
          Aquí podrás contestar tu evaluación de Atributos de Egreso.
        </p>

        <!-- Registro por clave de materia -->
        <div class="row middle gap-8" style="margin-top: 16px">
          <input
            id="inp-clave"
            class="inp"
            placeholder="Clave de materia (ej. SCD-1015)"
            style="max-width: 220px"
          />
          <button id="btn-registrar" class="btn btn-success">
            Registrar materia
          </button>
          <a class="btn btn-outline" href="/">Volver al inicio</a>
        </div>

        <div
          id="msg"
          class="form-msg"
          style="margin-top: 12px; display: none"
        ></div>
      </div>

      <div
        class="row"
        style="gap: 16px; align-items: flex-start; margin-bottom: 32px"
      >
        <!-- Pendientes -->
        <div class="card" style="flex: 1">
          <h3>Materias registradas (pendientes)</h3>
          <table class="table" id="tbl-pendientes">
            <thead>
              <tr>
                <th>Clave</th>
                <th>Nombre</th>
                <th>Acción</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <p id="empty-pendientes" class="muted">
            No tienes materias pendientes registradas.
          </p>
        </div>

        <!-- Evaluadas -->
        <div class="card" style="flex: 1">
          <h3>Materias evaluadas</h3>
          <table class="table" id="tbl-evaluadas">
            <thead>
              <tr>
                <th>Clave</th>
                <th>Nombre</th>
                <th>Respuestas</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <p id="empty-evaluadas" class="muted">
            Aún no has evaluado materias en el periodo.
          </p>
        </div>
      </div>
    </main>

    <script type="module">
      import { api } from "../assets/js/api.js";

      const saludoEl = document.getElementById("saludo");
      const resumenEl = document.getElementById("resumen-usuario");
      const logoutBtn = document.getElementById("btn-cerrar-sesion");

      const inpClave = document.getElementById("inp-clave");
      const btnRegistrar = document.getElementById("btn-registrar");
      const msg = document.getElementById("msg");

      const tblPendBody = document.querySelector("#tbl-pendientes tbody");
      const tblEvalBody = document.querySelector("#tbl-evaluadas tbody");
      const emptyPend = document.getElementById("empty-pendientes");
      const emptyEval = document.getElementById("empty-evaluadas");

      // Guard de sesión ALUMNO
      const me = await api("/api/auth/me");
      if (!me.auth || me.user.rol !== "ALUMNO") {
        location.href = "/alumno/login.html";
        throw new Error("Sesión no válida");
      }
      saludoEl.textContent = `¡Hola, ${me.user.nombre || "Alumno"}!`;
      resumenEl.textContent = me.user.email || "";

      logoutBtn.addEventListener("click", async () => {
        await api("/api/auth/logout", { method: "POST" });
        location.href = "/alumno/login.html";
      });

      // Helpers UI
      const showMsg = (text, type = "info") => {
        msg.textContent = text;
        msg.className = `form-msg ${type}`;
        msg.style.display = "block";
        setTimeout(() => {
          msg.style.display = "none";
        }, 5000);
      };

      function filaPendiente(m) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
        <td>${m.id_materia}</td>
        <td>${m.nom_materia}</td>
        <td><a class="btn btn-success" href="/alumno/encuesta.html?materia=${encodeURIComponent(
          m.id_materia
        )}">Responder</a></td>
      `;
        return tr;
      }
      function filaEvaluada(m) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
        <td>${m.id_materia}</td>
        <td>${m.nom_materia}</td>
        <td>${m.respuestas}</td>
      `;
        return tr;
      }

      async function cargarListas() {
        const data = await api("/api/alumno/materias");
        // Pendientes
        tblPendBody.innerHTML = "";
        if (data.pendientes.length) {
          emptyPend.style.display = "none";
          data.pendientes.forEach((m) =>
            tblPendBody.appendChild(filaPendiente(m))
          );
        } else {
          emptyPend.style.display = "block";
        }
        // Evaluadas
        tblEvalBody.innerHTML = "";
        if (data.evaluadas.length) {
          emptyEval.style.display = "none";
          data.evaluadas.forEach((m) =>
            tblEvalBody.appendChild(filaEvaluada(m))
          );
        } else {
          emptyEval.style.display = "block";
        }
      }

      btnRegistrar.addEventListener("click", async () => {
        const id = inpClave.value.trim().toUpperCase();
        if (!/^[A-Z]{3}-\d{4}$/.test(id)) {
          showMsg("Formato inválido. Usa algo como SCD-1015.", "warning");
          return;
        }
        try {
          const r = await api("/api/alumno/materias/registrar", {
            method: "POST",
            body: { id_materia: id },
          });
          if (r.estado === "pendiente") {
            showMsg(
              `Materia ${id} registrada. Puedes iniciar tu evaluación.`,
              "success"
            );
            await cargarListas();
          } else if (r.estado === "evaluada") {
            showMsg(`La materia ${id} ya fue evaluada en el periodo.`, "info");
            await cargarListas();
          } else {
            showMsg("Registro completado.", "success");
            await cargarListas();
          }
          inpClave.value = "";
        } catch (e) {
          showMsg(e.message || "No se pudo registrar la materia", "error");
        }
      });

      await cargarListas();
    </script>
  </body>
</html>
